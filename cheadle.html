<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Yardage Book ‚Äì Cheadle GC</title>

<link rel="icon" href="skratch.png" type="image/png">
<link rel="apple-touch-icon" href="cheadle.png" sizes="180x180">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Yardage Book">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
:root{
  --accent:#007AFF;
  --bg:#f5f6f7;
  --card:rgba(255,255,255,0.88);
  --border:rgba(0,0,0,0.08);
  --text:#1d1d1f;
  --muted:#6e6e73;

  --greenFill: rgba(52,199,89,0.22);
  --greenStroke: rgba(0,122,255,0.90);
  --bunkerFill: rgba(255,159,10,0.22);
  --bunkerStroke: rgba(255,149,0,0.95);
}

*{box-sizing:border-box}

body{
  margin:0;
  padding:1rem;
  padding-bottom:10rem;
  background:var(--bg);
  font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","SF Pro Display","Helvetica Neue",Helvetica,Arial,sans-serif;
  color:var(--text);
}

h1{
  text-align:center;
  font-size:1.6rem;
  font-weight:800;
  margin:.5rem 0 .25rem;
}

.card{
  background:var(--card);
  backdrop-filter:blur(14px);
  border:1px solid var(--border);
  border-radius:16px;
  padding:1rem;
  margin:.75rem auto;
  max-width:420px;
  box-shadow:0 10px 30px rgba(0,0,0,.12);
}

#yardageStatusTop,
#compassStatus{
  text-align:center;
  font-weight:800;
  color:var(--muted);
  margin:.25rem auto;
}

#map{
  height:340px;
  border-radius:18px;
  border:1px solid var(--border);
  margin:1rem auto;
  max-width:420px;
  overflow:hidden;
}

select,button{
  width:100%;
  padding:.75rem 1rem;
  border-radius:14px;
  font-size:1rem;
  font-weight:700;
  border:1px solid var(--border);
}

button{
  background:var(--accent);
  color:white;
  border:none;
  box-shadow:0 6px 16px rgba(0,122,255,.35);
  margin-top:.5rem;
}

button.secondary{
  background:white;
  color:var(--accent);
  box-shadow:none;
  border:1px solid var(--border);
}

button.pill{
  width:auto;
  padding:.55rem .9rem;
  border-radius:999px;
  margin-top:0;
}

.segmented{
  display:flex;
  gap:.5rem;
  margin-top:.75rem;
}
.segmented button{
  flex:1;
  box-shadow:none;
  border:1px solid var(--border);
  background:white;
  color:var(--text);
}
.segmented button.active{
  background:var(--accent);
  color:white;
  border-color:transparent;
}

#distanceDisplay{
  text-align:center;
  font-size:1.25rem;
  font-weight:900;
  margin-top:.6rem;
}
#distanceSub{
  text-align:center;
  font-size:.9rem;
  color:var(--muted);
  font-weight:700;
  margin-top:.2rem;
  display:none;
}
#clubSuggestion{
  text-align:center;
  font-weight:900;
  color:var(--accent);
  margin-top:.35rem;
}

#headingLabel{
  text-align:center;
  font-size:.95rem;
  color:var(--muted);
  display:none;
  margin-top:.35rem;
}

#weatherBox{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:.75rem;
}
#weatherBox img{
  width:54px;
  height:54px;
}

/* Footer */
.footerBar{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  background:rgba(255,255,255,.9);
  backdrop-filter:blur(14px);
  border-top:1px solid var(--border);
  padding:.75rem;
  z-index:999;
}
.footerInner{max-width:420px;margin:auto;text-align:center}
.footerActions{
  display:flex;
  justify-content:center;
  gap:.6rem;
}
.footerActions button{
  width:auto;
  padding:.55rem .9rem;
  border-radius:999px;
  margin-top:0;
}
.footerText{
  font-size:.75rem;
  color:var(--muted);
  margin-top:.5rem;
}

/* Markers: no box/background */
.arrowBubble{
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
  width: auto !important;
  height: auto !important;
  border-radius: 0 !important;
  padding: 0 !important;

  color: #007AFF;
  font-size: 24px;
  font-weight: 900;
  line-height: 1;
}
.leaflet-div-icon{
  background: transparent !important;
  border: none !important;
}

/* Make the layer control feel a bit more ‚ÄúiOS‚Äù */
.leaflet-control-layers{
  border:1px solid rgba(0,0,0,0.10) !important;
  border-radius:14px !important;
  box-shadow:0 10px 30px rgba(0,0,0,.14) !important;
  overflow:hidden;
}
.leaflet-control-layers-expanded{
  background:rgba(255,255,255,0.9) !important;
  backdrop-filter:blur(14px);
}

/* Tiny labels on map (FBM etc) */
.mapTag{
  background:rgba(255,255,255,0.85);
  backdrop-filter: blur(10px);
  border:1px solid rgba(0,0,0,0.10);
  border-radius:999px;
  padding:.18rem .5rem;
  font-weight:900;
  font-size:.75rem;
  color:var(--text);
  box-shadow:0 6px 18px rgba(0,0,0,.12);
}
</style>
</head>

<body>

<h1>Yardage Book</h1>
<div id="yardageStatusTop">Club Yardages: Not loaded</div>
<div id="compassStatus">Compass: Off</div>

<div id="weatherBox" class="card">Loading weather‚Ä¶</div>

<div id="map"></div>

<div class="card">
  <select id="holeSelect" onchange="showHoleLayout()">
    <option value="">Select Hole</option>
    <option value="1">Hole 1</option>
    <option value="2">Hole 2</option>
    <option value="3">Hole 3</option>
    <option value="4">Hole 4</option>
    <option value="5">Hole 5</option>
    <option value="6">Hole 6</option>
    <option value="7">Hole 7</option>
    <option value="8">Hole 8</option>
    <option value="9">Hole 9</option>
  </select>

  <!-- VIEW MODE TOGGLE -->
  <div class="segmented" style="margin-top:.75rem;">
    <button id="holeViewBtn" class="active" onclick="setViewMode('hole')">üèåÔ∏è Hole</button>
    <button id="greenViewBtn" onclick="setViewMode('green')">üü¢ Green</button>
  </div>

  <div id="distanceDisplay">Distance: --</div>
  <div id="distanceSub">Front: -- ‚Ä¢ Middle: -- ‚Ä¢ Back: --</div>
  <div id="clubSuggestion">Suggested Club: --</div>
  <div id="headingLabel">You‚Äôre pointing: --</div>

  <button class="secondary" onclick="openYardageSheet()">üìä View Yardages</button>
</div>

<input type="file" id="yardageFile" accept=".json" hidden>

<!-- Footer -->
<div class="footerBar">
  <div class="footerInner">
    <div class="footerActions">
      <button class="secondary pill" title="Add YardageBook.json" onclick="yardageFile.click()">‚ûï</button>
      <button class="secondary pill" title="Clear stored club yardages" onclick="clearYardageBook()">üóëÔ∏è</button>
      <button class="secondary pill" id="compassToggleBtn" title="Toggle compass" onclick="toggleCompass()">üß≠</button>
    </div>
    <div class="footerText">Powered by ForeThought.site ‚Ä¢ An Apple Geek Product</div>
    <div class="footerText">v1.0.2</div>
    <div class="footerText">Create a Yardage Gapping Table <a href="https://forethought.site/yardagebook.html">Here</a></div>
  </div>
</div>

<!-- Yardage Sheet -->
<div id="yardageSheet" style="position:fixed;inset:0;display:none;background:rgba(0,0,0,.35);backdrop-filter:blur(6px);align-items:flex-end;justify-content:center;z-index:2000;">
  <div style="background:white;border-radius:20px 20px 0 0;width:100%;max-width:420px;padding:1rem">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong>Yardages</strong>
      <button class="secondary pill" onclick="closeYardageSheet()">Done</button>
    </div>
    <div id="yardageList" style="margin-top:.5rem;max-height:75vh;overflow:auto"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* =========================================================
   Yardage Book v1.0.2
   - Hole view + Green view
   - Green complex layouts: A (simple), B (styled), C (GeoJSON-ready)
   ========================================================= */

/* ---------- Map Layers ---------- */
let map = L.map("map").setView([53.387, -2.205], 17);

const street = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19,
  attribution: "&copy; OpenStreetMap contributors"
});

const satellite = L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
  { maxZoom: 19, attribution: "Tiles &copy; Esri" }
);

street.addTo(map);
L.control.layers({"Map": street, "Satellite": satellite}, null, { position: "topright" }).addTo(map);

/* ---------- Icons ---------- */
const teeIcon = L.divIcon({
  className: "",
  html: `<div class="arrowBubble">üìç</div>`,
  iconSize: [24,24],
  iconAnchor: [12,12]
});
const greenIcon = L.divIcon({
  className: "",
  html: `<div class="arrowBubble">‚õ≥Ô∏è</div>`,
  iconSize: [24,24],
  iconAnchor: [12,12]
});
const pinIcon = L.divIcon({
  className: "",
  html: `<div class="arrowBubble">üìå</div>`,
  iconSize: [24,24],
  iconAnchor: [12,12]
});

/* ---------- View Mode ---------- */
let viewMode = "hole"; // "hole" | "green"
function setViewMode(mode){
  viewMode = mode;

  const holeBtn = document.getElementById("holeViewBtn");
  const greenBtn = document.getElementById("greenViewBtn");

  holeBtn.classList.toggle("active", mode === "hole");
  greenBtn.classList.toggle("active", mode === "green");

  showHoleLayout();
}

/* ---------- Hole Data (base + optional green complexes) ---------- */
/*
  Green layout support:
  A) greenShape: simple polygon (easy hand-edit)
  B) styled polygon + bunkers + tags (done below)
  C) geojson: full GeoJSON (proper trace from geojson.io etc.)
*/
const yardageData = {
 "1":{
   whiteTee:{lat:53.388113,lng:-2.2067},
   green:{lat:53.385712,lng:-2.205569},

   // Front / back points (approx) for F/M/B distances in Green View
   greenFront:{lat:53.385756,lng:-2.205598},
   greenBack:{lat:53.385680,lng:-2.205535},

   // Option A: simple polygon (works instantly)
   greenShape:[
     [53.385742,-2.205620],
     [53.385768,-2.205560],
     [53.385740,-2.205500],
     [53.385695,-2.205485],
     [53.385660,-2.205535],
     [53.385670,-2.205600]
   ],

   // Option B: bunkers / surrounds (approx)
   bunkers:[
     [
       [53.385735,-2.205455],
       [53.385760,-2.205430],
       [53.385780,-2.205470],
       [53.385750,-2.205495]
     ]
   ],

   // Option C: GeoJSON-ready (example for Hole 1 only)
   // Replace/extend these with traced shapes later.
   geojson:{
     "type":"FeatureCollection",
     "features":[
       {
         "type":"Feature",
         "properties":{"kind":"green"},
         "geometry":{
           "type":"Polygon",
           "coordinates":[[
             [-2.205620,53.385742],
             [-2.205560,53.385768],
             [-2.205500,53.385740],
             [-2.205485,53.385695],
             [-2.205535,53.385660],
             [-2.205600,53.385670],
             [-2.205620,53.385742]
           ]]
         }
       },
       {
         "type":"Feature",
         "properties":{"kind":"bunker"},
         "geometry":{
           "type":"Polygon",
           "coordinates":[[
             [-2.205455,53.385735],
             [-2.205430,53.385760],
             [-2.205470,53.385780],
             [-2.205495,53.385750],
             [-2.205455,53.385735]
           ]]
         }
       }
     ]
   }
 },

 "2":{whiteTee:{lat:53.386272,lng:-2.205266},green:{lat:53.385069,lng:-2.206453}},
 "3":{whiteTee:{lat:53.386122,lng:-2.206867},green:{lat:53.383919,lng:-2.204562}},
 "4":{whiteTee:{lat:53.384254,lng:-2.20314},green:{lat:53.387625,lng:-2.202824}},
 "5":{whiteTee:{lat:53.38782,lng:-2.202718},green:{lat:53.387667,lng:-2.203872}},
 "6":{whiteTee:{lat:53.388148,lng:-2.203193},green:{lat:53.384237,lng:-2.203861}},
 "7":{whiteTee:{lat:53.384161,lng:-2.204177},green:{lat:53.385387,lng:-2.205308}},
 "8":{whiteTee:{lat:53.38418,lng:-2.204066},green:{lat:53.387473,lng:-2.20485}},
 "9":{whiteTee:{lat:53.387703,lng:-2.204087},green:{lat:53.387958,lng:-2.206264}}
};

/* ---------- State Layers ---------- */
let teeMarker=null, greenMarker=null, holeLine=null, userMarker=null, pinMarker=null;
let greenOverlayGroup = L.layerGroup().addTo(map);
let tagGroup = L.layerGroup().addTo(map);

/* ---------- GPS ---------- */
navigator.geolocation.watchPosition(
  (pos)=>{
    const {latitude, longitude} = pos.coords;
    if(!userMarker){
      userMarker = L.marker([latitude, longitude], { title: "Your Location" }).addTo(map);
    } else {
      userMarker.setLatLng([latitude, longitude]);
    }
    showHoleLayout();
  },
  (err)=>console.warn("GPS Error:", err.message),
  { enableHighAccuracy:true }
);

/* ---------- Distance ---------- */
function getDistance(a,b){
  const R=6371e3, toRad=x=>x*Math.PI/180;
  const dLat=toRad(b.lat-a.lat), dLon=toRad(b.lng-a.lng);
  const aa=Math.sin(dLat/2)**2 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLon/2)**2;
  return R*(2*Math.atan2(Math.sqrt(aa), Math.sqrt(1-aa)));
}
function toYards(m){ return Math.round(m * 1.09361); }

/* =========================================================
   YARDAGEBOOK (persist + restore + suggest + popup)
   ========================================================= */
let yardageBook = null;

function setYardageStatus(ok){
  const el = document.getElementById("yardageStatusTop");
  el.textContent = ok ? "Club Yardages: Loaded ‚úì" : "Club Yardages: Not loaded";
  el.style.color = ok ? "var(--accent)" : "var(--muted)";
}

function validateBook(j){
  return j?.type === "yardageBook" &&
         j?.source === "ForeThought" &&
         Array.isArray(j.clubs) &&
         j.clubs.every(c => typeof c.name === "string" && typeof c.carry === "number");
}

(function restoreYardageBook(){
  try{
    const raw = localStorage.getItem("yardageBookJSON");
    if(!raw) return setYardageStatus(false);
    const j = JSON.parse(raw);
    if(!validateBook(j)) throw 0;
    yardageBook = j;
    setYardageStatus(true);
  }catch{
    localStorage.removeItem("yardageBookJSON");
    setYardageStatus(false);
  }
})();

document.getElementById("yardageFile").addEventListener("change", (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;

  const r = new FileReader();
  r.onload = () => {
    try{
      const j = JSON.parse(r.result);
      if(!validateBook(j)) return alert("Invalid ForeThought YardageBook.json");
      yardageBook = j;
      localStorage.setItem("yardageBookJSON", JSON.stringify(j));
      setYardageStatus(true);
      showHoleLayout();
    }catch{
      alert("Couldn‚Äôt read that JSON file.");
    }
  };
  r.readAsText(f);
});

function clearYardageBook(){
  if(!confirm("Clear stored club yardages?")) return;
  localStorage.removeItem("yardageBookJSON");
  yardageBook = null;
  setYardageStatus(false);
  document.getElementById("clubSuggestion").textContent = "Suggested Club: --";
}

function suggestClub(yards){
  if(!yardageBook) return null;

  let best=null, bestDiff=Infinity;
  for(const c of yardageBook.clubs){
    const diff = Math.abs(c.carry - yards);
    if(diff <= 10 && diff < bestDiff){
      best = c;
      bestDiff = diff;
    }
  }
  return best;
}

function openYardageSheet(){
  if(!yardageBook) return alert("No YardageBook loaded");

  const list = document.getElementById("yardageList");
  list.innerHTML = "";

  const m = document.getElementById("distanceDisplay").textContent.match(/(\d+)/);
  const y = m ? parseInt(m[1], 10) : null;
  const s = y ? suggestClub(y) : null;

  for(const c of yardageBook.clubs){
    const hl = s && s.name === c.name;
    const row = document.createElement("div");
    row.style.display = "flex";
    row.style.justifyContent = "space-between";
    row.style.padding = ".55rem 0";
    row.style.borderBottom = "1px solid #eee";
    row.style.fontWeight = hl ? "900" : "700";
    row.style.color = hl ? "var(--accent)" : "inherit";
    row.innerHTML = `<div>${c.name}</div><div style="color:${hl?"var(--accent)":"var(--muted)"}">${c.carry}y${typeof c.total==="number" ? ` ‚Ä¢ ${c.total}y` : ""}</div>`;
    list.appendChild(row);
  }

  document.getElementById("yardageSheet").style.display = "flex";
}
function closeYardageSheet(){
  document.getElementById("yardageSheet").style.display = "none";
}

/* =========================================================
   GREEN COMPLEX DRAWING (A + B + C)
   ========================================================= */
function clearGreenOverlays(){
  greenOverlayGroup.clearLayers();
  tagGroup.clearLayers();
  if(pinMarker){ map.removeLayer(pinMarker); pinMarker = null; }
}

function addTag(latlng, text){
  const m = L.marker(latlng, {
    icon: L.divIcon({
      className:"",
      html:`<div class="mapTag">${text}</div>`,
      iconSize:[1,1],
      iconAnchor:[0,0]
    }),
    interactive:false
  });
  tagGroup.addLayer(m);
}

function styleForFeature(feature){
  const kind = feature?.properties?.kind;
  if(kind === "bunker"){
    return { color: getCSS("--bunkerStroke"), weight:2, fillColor:getCSS("--bunkerFill"), fillOpacity:0.22 };
  }
  // default green
  return { color: getCSS("--greenStroke"), weight:2, fillColor:getCSS("--greenFill"), fillOpacity:0.22 };
}
function getCSS(name){
  return getComputedStyle(document.documentElement).getPropertyValue(name).trim() || "#007AFF";
}

function drawGreenComplex(holeKey){
  clearGreenOverlays();

  const hole = yardageData[holeKey];
  if(!hole) return;

  // Always drop a "pin" at the green centre (feel nicer than ‚õ≥Ô∏è in Green View)
  pinMarker = L.marker([hole.green.lat, hole.green.lng], { icon: pinIcon, title:"Green Centre" }).addTo(map);

  // OPTION C: GeoJSON (best). If present, use it.
  if(hole.geojson){
    const layer = L.geoJSON(hole.geojson, {
      style: styleForFeature,
      pointToLayer: (feature, latlng) => L.circleMarker(latlng, { radius:4 })
    });
    greenOverlayGroup.addLayer(layer);
    return;
  }

  // OPTION B: styled green polygon + bunkers (if present)
  if(Array.isArray(hole.greenShape) && hole.greenShape.length >= 3){
    const greenPoly = L.polygon(hole.greenShape, {
      color: getCSS("--greenStroke"),
      weight: 2,
      fillColor: getCSS("--greenFill"),
      fillOpacity: 0.22
    });
    greenOverlayGroup.addLayer(greenPoly);
  }

  if(Array.isArray(hole.bunkers)){
    for(const b of hole.bunkers){
      const bunkerPoly = L.polygon(b, {
        color: getCSS("--bunkerStroke"),
        weight: 2,
        fillColor: getCSS("--bunkerFill"),
        fillOpacity: 0.22
      });
      greenOverlayGroup.addLayer(bunkerPoly);
    }
  }

  // OPTION A fallback: if no shapes at all, make a small circle around green
  if(!hole.geojson && !hole.greenShape){
    const circ = L.circle([hole.green.lat, hole.green.lng], {
      radius: 18,
      color: getCSS("--greenStroke"),
      weight: 2,
      fillColor: getCSS("--greenFill"),
      fillOpacity: 0.18
    });
    greenOverlayGroup.addLayer(circ);
  }
}

/* =========================================================
   DRAW HOLE + SUGGEST CLUB + GREEN VIEW
   ========================================================= */
function showHoleLayout(){
  const h = document.getElementById("holeSelect").value;
  if(!h || !yardageData[h] || !userMarker) return;

  const hole = yardageData[h];
  const { whiteTee, green } = hole;

  // Clear old overlays (hole line + tee/green markers)
  if(teeMarker) map.removeLayer(teeMarker);
  if(greenMarker) map.removeLayer(greenMarker);
  if(holeLine) map.removeLayer(holeLine);

  // Always redraw green complex (it‚Äôs light)
  drawGreenComplex(h);

  // In HOLE VIEW we show tee + line + green marker
  if(viewMode === "hole"){
    teeMarker = L.marker([whiteTee.lat, whiteTee.lng], { icon: teeIcon, title: "Tee" }).addTo(map);
    greenMarker = L.marker([green.lat, green.lng], { icon: greenIcon, title: "Green" }).addTo(map);

    holeLine = L.polyline([[whiteTee.lat, whiteTee.lng],[green.lat, green.lng]], {
      color:"#007AFF",
      weight:4,
      opacity:0.9
    }).addTo(map);

    map.fitBounds(holeLine.getBounds(), { padding:[30,30] });
  } else {
    // GREEN VIEW: zoom tight on green + show shape/bunkers + pin
    map.setView([green.lat, green.lng], 19);

    // Optional labels if you like
    addTag([green.lat, green.lng], "MID");
  }

  // Distance to green from user position (always shown)
  const distToMidM = getDistance(userMarker.getLatLng(), green);
  const midY = toYards(distToMidM);
  document.getElementById("distanceDisplay").textContent = `Distance: ${midY} yards`;

  // F/M/B distances for Green View (only if points exist)
  const sub = document.getElementById("distanceSub");
  if(viewMode === "green" && hole.greenFront && hole.greenBack){
    const frontY = toYards(getDistance(userMarker.getLatLng(), hole.greenFront));
    const backY  = toYards(getDistance(userMarker.getLatLng(), hole.greenBack));
    sub.style.display = "block";
    sub.textContent = `Front: ${frontY} ‚Ä¢ Middle: ${midY} ‚Ä¢ Back: ${backY}`;
  } else {
    sub.style.display = "none";
    sub.textContent = "Front: -- ‚Ä¢ Middle: -- ‚Ä¢ Back: --";
  }

  // Suggest club (from MID distance, YardageBook loaded)
  const c = suggestClub(midY);
  document.getElementById("clubSuggestion").textContent = c
    ? `Suggested Club: ${c.name} ‚Ä¢ ${c.carry}y carry`
    : "Suggested Club: --";
}

/* =========================================================
   COMPASS (persist + restore + label)
   ========================================================= */
let compassEnabled = false;
let compassListener = null;

function updateCompassStatus(){
  const status = document.getElementById("compassStatus");
  const btn = document.getElementById("compassToggleBtn");

  if(compassEnabled){
    status.innerHTML = "Compass: <span style='color:var(--accent);font-weight:800'>Enabled ‚úì</span>";
    btn.style.background = "var(--accent)";
    btn.style.color = "white";
    btn.style.borderColor = "transparent";
  } else {
    status.textContent = "Compass: Off";
    btn.style.background = "";
    btn.style.color = "";
    btn.style.borderColor = "";
  }
}

function toggleCompass(){
  compassEnabled ? disableCompass() : enableCompass();
}

function enableCompass(){
  function start(){
    compassListener = (event)=>{
      let heading = event.alpha;

      if(typeof event.webkitCompassHeading !== "undefined" && event.webkitCompassHeading !== null){
        heading = event.webkitCompassHeading;
      }
      if(heading == null) return;

      heading = (heading % 360 + 360) % 360;
      const dirs = ["N","NE","E","SE","S","SW","W","NW"];
      const dir = dirs[Math.round(heading/45) % 8];

      const label = document.getElementById("headingLabel");
      label.style.display = "block";
      label.textContent = `You‚Äôre pointing: ${dir} (${Math.round(heading)}¬∞)`;
    };

    window.addEventListener("deviceorientation", compassListener, true);

    compassEnabled = true;
    localStorage.setItem("compassEnabled", "true");
    updateCompassStatus();

    const label = document.getElementById("headingLabel");
    label.style.display = "block";
    label.textContent = "You‚Äôre pointing: --";
  }

  if(typeof DeviceOrientationEvent !== "undefined" &&
     typeof DeviceOrientationEvent.requestPermission === "function"){

    DeviceOrientationEvent.requestPermission().then(r=>{
      if(r === "granted") start();
      else {
        compassEnabled = false;
        localStorage.setItem("compassEnabled","false");
        updateCompassStatus();
        alert(
          "Compass access is disabled.\n\n" +
          "To enable it:\n" +
          "‚Ä¢ Use HTTPS\n" +
          "‚Ä¢ Settings ‚Üí Safari ‚Üí Motion & Orientation Access ‚Üí Allow\n" +
          "‚Ä¢ Reload the page"
        );
      }
    }).catch(console.error);

  } else {
    start();
  }
}

function disableCompass(){
  if(compassListener){
    window.removeEventListener("deviceorientation", compassListener, true);
    compassListener = null;
  }
  compassEnabled = false;
  localStorage.setItem("compassEnabled", "false");
  updateCompassStatus();

  const label = document.getElementById("headingLabel");
  label.style.display = "none";
  label.textContent = "You‚Äôre pointing: --";
}

(function restoreCompassState(){
  const saved = localStorage.getItem("compassEnabled");
  if(saved === "true") enableCompass();
  else updateCompassStatus();
})();

/* =========================================================
   WEATHER (robust + icon + wind + fallback)
   ========================================================= */
async function loadWeather(){
  const box = document.getElementById("weatherBox");
  try{
    const url = "https://api.openweathermap.org/data/2.5/weather?lat=53.387&lon=-2.205&units=metric&appid=e583bd0c194bbfeb3deb92f6bfdad11a";
    const res = await fetch(url, { cache: "no-store" });

    if(!res.ok){
      throw new Error("Weather HTTP " + res.status);
    }

    const d = await res.json();
    if(!d?.main?.temp || !d?.weather?.[0]) throw new Error("Weather payload missing fields");

    const temp = Math.round(d.main.temp);
    const windMph = d.wind?.speed != null ? Math.round(d.wind.speed * 2.237) : null;
    const windDirDeg = d.wind?.deg;
    const directions = ["N","NE","E","SE","S","SW","W","NW"];
    const windDir = (windDirDeg != null) ? directions[Math.round(windDirDeg / 45) % 8] : null;

    const icon = d.weather[0].icon;
    const desc = d.weather[0].description;

    box.innerHTML = `
      <img src="https://openweathermap.org/img/wn/${icon}@2x.png" alt="${desc}">
      <div>
        <strong>Cheadle GC</strong><br>
        ${temp}¬∞C ‚Ä¢ ${desc}<br>
        ${windMph != null && windDir != null ? `Wind: ${windMph} mph ${windDir}` : `Wind: --`}
      </div>
    `;
  }catch(err){
    console.warn("Weather error:", err);
    box.innerHTML = `
      <div style="text-align:center;color:var(--muted);font-weight:800;">
        Weather unavailable
        <div style="font-weight:700;font-size:.85rem;margin-top:.25rem;">
          Check connection / API limit
        </div>
      </div>
    `;
  }
}
loadWeather();

/* Small nicety: start in hole view visually */
setViewMode("hole");
</script>

</body>
</html>
